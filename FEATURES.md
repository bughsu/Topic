# Qt6 專業多路監控錄影系統 - 智慧移動偵測

## 功能概述

這是一個基於 Qt6 和 FFmpeg 的專業多路監控錄影系統，整合了 OpenCV 實現智慧移動偵測功能。

## 主要功能

### 1. 多路視訊串流播放
- 支援多個串流來源同時播放
- 支援 RTSP、HTTP、MJPEG 等多種串流格式
- 九宮格顯示，可點擊放大單個畫面

### 2. 智慧移動偵測 ⭐ (新功能)
- 使用 OpenCV MOG2 背景減除算法進行移動偵測
- 即時分析視訊畫面，當畫面像素變化超過閾值時自動觸發事件
- 可調整偵測靈敏度（1%-10%）
- 連續多幀確認機制，減少誤報
- 自動儲存移動偵測快照

### 3. 事件日誌系統 ⭐ (新功能)
- 記錄所有重要事件：
  - 移動偵測事件（含移動強度）
  - 錄影開始/停止
  - 串流連接/斷線
- 事件持久化儲存（JSON 格式）
- 事件瀏覽和查詢功能
- 可清除歷史記錄

### 4. 自動錄影功能
- 全域錄影控制
- 支援多路同時錄影
- 偵測到移動時自動開始錄影（可選）
- 使用 FFmpeg 進行高效錄影

### 5. 錄影檔案管理
- 內建影片播放器
- 支援外部播放器開啟
- 影片刪除功能
- 檔案大小顯示

## 技術架構

### 依賴項目
- **Qt6**: 核心框架（multimedia, multimediawidgets, network）
- **FFmpeg 8.0.1**: 視訊錄影和處理
- **OpenCV 4.10.0**: 影像處理和移動偵測

### 核心模組

#### EventLogger（事件日誌器）
- 管理所有系統事件的記錄
- 支援事件類型過濾和時間範圍查詢
- JSON 格式持久化儲存

#### MotionDetector（移動偵測器）
- 使用 MOG2 背景減除算法
- 高斯模糊降噪
- 形態學操作去除小雜訊
- 可配置的靈敏度閾值

#### MainWindow（主窗口）
- 整合所有功能模組
- 管理多個播放器單元
- UI 控制和事件處理

## 使用說明

### 安裝需求

1. **Qt6 開發環境**
   - Qt 6.x 或更高版本
   - 包含 multimedia 模組

2. **FFmpeg**
   - 下載 FFmpeg 8.0.1 或更高版本
   - 將 `ffmpeg.exe` 放入系統 PATH 或程式目錄
   - 下載地址：https://www.gyan.dev/ffmpeg/builds/

3. **OpenCV**
   - 下載 OpenCV 4.x 版本
   - 配置 `Topic.pro` 中的 `OPENCV_PATH`
   - 下載地址：https://opencv.org/releases/

### 設定步驟

1. **編輯 Topic.pro**
   ```qmake
   # 設定 FFmpeg 路徑
   FFMPEG_PATH = "C:/path/to/ffmpeg"
   
   # 設定 OpenCV 路徑
   OPENCV_PATH = "C:/path/to/opencv/build"
   ```

2. **建置專案**
   - 使用 Qt Creator 開啟 `Topic.pro`
   - 選擇合適的 Kit（Desktop Qt 6.x）
   - 建置並執行

### 操作指南

#### 新增串流來源
1. 點擊「新增來源」按鈕
2. 輸入串流 URL 或本地檔案路徑
   - RTSP 範例：`rtsp://example.com/stream`
   - HTTP 範例：`http://example.com/stream.mjpeg`
   - 測試影片：`https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4`
3. 選擇新增的來源，點擊「開始播放」

#### 啟用移動偵測
1. 確保至少有一個串流正在播放
2. 調整「靈敏度」滑桿（建議 2-5%）
3. 點擊「啟用移動偵測」按鈕
4. （可選）勾選「偵測到移動時自動錄影」

#### 查看事件日誌
1. 點擊「事件日誌」按鈕
2. 查看所有記錄的事件
3. 可按時間、類型排序
4. 移動偵測事件會以淺紅色標示

#### 錄影操作
1. **手動錄影**：點擊「開啟全域錄影」
2. **自動錄影**：啟用「偵測到移動時自動錄影」選項
3. 錄影檔案儲存在 `recordings/` 資料夾

#### 檔案管理
1. 點擊「檔案管理」按鈕
2. 雙擊影片即可在內建播放器播放
3. 使用「用外部播放器開啟」以系統預設播放器開啟
4. 使用「開啟錄影資料夾」直接瀏覽檔案

## 目錄結構

```
Qt_11401_12/
├── main.cpp                # 程式入口
├── mainwindow.h/cpp        # 主窗口
├── motiondetector.h/cpp    # 移動偵測模組
├── eventlogger.h/cpp       # 事件日誌模組
├── Topic.pro               # Qt 專案檔
├── recordings/             # 錄影檔案（自動建立）
├── logs/                   # 事件日誌（自動建立）
│   └── event_log.json      # JSON 格式的事件記錄
└── README.md               # 本檔案
```

## 技術細節

### 移動偵測算法
```
1. 影格擷取（每 500ms）
2. 轉換為灰階影像
3. 高斯模糊（21x21 核心）
4. MOG2 背景減除
5. 形態學操作（開運算 + 閉運算）
6. 計算前景像素比例
7. 與閾值比較
8. 連續 3 幀確認後觸發事件
```

### 事件日誌格式
```json
[
  {
    "timestamp": "2025-12-29T05:48:00",
    "type": 0,
    "streamUrl": "rtsp://example.com/stream",
    "description": "偵測到移動 (強度: 3.45%)",
    "imageSnapshotPath": "recordings/snapshot_20251229_054800.jpg",
    "motionLevel": 0.0345
  }
]
```

## 性能優化建議

1. **影格擷取頻率**：預設 500ms，可根據 CPU 性能調整
2. **移動偵測靈敏度**：建議 2-5%，過低會增加誤報
3. **連續確認幀數**：預設 3 幀，可根據需求調整
4. **錄影格式**：使用 H.264 編碼以平衡品質和檔案大小

## 故障排除

### FFmpeg 相關
- **問題**：錄影啟動失敗
- **解決**：
  1. 確認 FFmpeg 已安裝且在 PATH 中
  2. 檢查串流 URL 是否正確
  3. 查看應用程式輸出視窗的 FFmpeg 訊息

### OpenCV 相關
- **問題**：移動偵測無法啟用
- **解決**：
  1. 確認 OpenCV DLL 在程式目錄或 PATH 中
  2. 檢查 Topic.pro 中的 OpenCV 路徑設定
  3. 確認 OpenCV 版本與編譯器相容

### 移動偵測誤報
- **解決**：
  1. 提高靈敏度閾值（例如從 2% 提高到 5%）
  2. 確保攝影機固定，減少畫面晃動
  3. 調整光線，避免陰影變化

## 未來改進方向

- [ ] 支援物件辨識（人臉、車輛等）
- [ ] 移動軌跡追蹤
- [ ] 事件通知（郵件、推播）
- [ ] 雲端儲存整合
- [ ] 多使用者權限管理
- [ ] 行動裝置 App 支援

## 授權

本專案僅供學習和研究使用。

## 聯絡資訊

如有問題或建議，請聯絡專案維護者。
